# pxos_text.py
from __future__ import annotations
from dataclasses import dataclass
from typing import Dict, Sequence, Tuple
import numpy as np

# Minimal 8x8 glyphs for demo. You can extend this table over time.
GLYPHS: Dict[str, Sequence[int]] = {
    "A": [
        0b00111100,
        0b01000010,
        0b01000010,
        0b01111110,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00000000,
    ],
    "B": [
        0b01111100,
        0b01000010,
        0b01000010,
        0b01111100,
        0b01000010,
        0b01000010,
        0b01111100,
        0b00000000,
    ],
    "C": [
        0b00111100,
        0b01000010,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000010,
        0b00111100,
        0b00000000,
    ],
    "D": [
        0b01111000,
        0b01000100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000100,
        0b01111000,
        0b00000000,
    ],
    "E": [
        0b01111110,
        0b01000000,
        0b01000000,
        0b01111100,
        0b01000000,
        0b01000000,
        0b01111110,
        0b00000000,
    ],
    "F": [
        0b01111110,
        0b01000000,
        0b01000000,
        0b01111100,
        0b01000000,
        0b01000000,
        0b01000000,
        0b00000000,
    ],
    "G": [
        0b00111100,
        0b01000010,
        0b01000000,
        0b01001110,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
    ],
    "H": [
        0b01000010,
        0b01000010,
        0b01000010,
        0b01111110,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00000000,
    ],
    "I": [
        0b00111110,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00111110,
        0b00000000,
    ],
    "J": [
        0b00011111,
        0b00000100,
        0b00000100,
        0b00000100,
        0b01000100,
        0b01000100,
        0b00111000,
        0b00000000,
    ],
    "K": [
        0b01000010,
        0b01000100,
        0b01001000,
        0b01110000,
        0b01001000,
        0b01000100,
        0b01000010,
        0b00000000,
    ],
    "L": [
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01111110,
        0b00000000,
    ],
    "M": [
        0b01000010,
        0b01100110,
        0b01011010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00000000,
    ],
    "N": [
        0b01000010,
        0b01100010,
        0b01010010,
        0b01001010,
        0b01000110,
        0b01000010,
        0b01000010,
        0b00000000,
    ],
    "O": [
        0b00111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
    ],
    "P": [
        0b01111100,
        0b01000010,
        0b01000010,
        0b01111100,
        0b01000000,
        0b01000000,
        0b01000000,
        0b00000000,
    ],
    "Q": [
        0b00111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01001010,
        0b01000100,
        0b00111010,
        0b00000000,
    ],
    "R": [
        0b01111100,
        0b01000010,
        0b01000010,
        0b01111100,
        0b01001000,
        0b01000100,
        0b01000010,
        0b00000000,
    ],
    "S": [
        0b00111100,
        0b01000010,
        0b01000000,
        0b00111100,
        0b00000010,
        0b01000010,
        0b00111100,
        0b00000000,
    ],
    "T": [
        0b01111111,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00000000,
    ],
    "U": [
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
    ],
    "V": [
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00100100,
        0b00011000,
        0b00000000,
    ],
    "W": [
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01011010,
        0b01100110,
        0b01000010,
        0b00000000,
    ],
    "X": [
        0b01000010,
        0b01000010,
        0b00100100,
        0b00011000,
        0b00100100,
        0b01000010,
        0b01000010,
        0b00000000,
    ],
    "Y": [
        0b01000010,
        0b01000010,
        0b01000010,
        0b00100100,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00000000,
    ],
    "Z": [
        0b01111110,
        0b00000010,
        0b00000100,
        0b00011000,
        0b00100000,
        0b01000000,
        0b01111110,
        0b00000000,
    ],
    "0": [
        0b00111100,
        0b01000110,
        0b01001010,
        0b01010010,
        0b01100010,
        0b01000010,
        0b00111100,
        0b00000000,
    ],
    "1": [
        0b00011000,
        0b00101000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00111110,
        0b00000000,
    ],
    "2": [
        0b00111100,
        0b01000010,
        0b00000010,
        0b00001100,
        0b00110000,
        0b01000000,
        0b01111110,
        0b00000000,
    ],
    "3": [
        0b00111100,
        0b01000010,
        0b00000010,
        0b00011100,
        0b00000010,
        0b01000010,
        0b00111100,
        0b00000000,
    ],
    "4": [
        0b00001100,
        0b00010100,
        0b00100100,
        0b01000100,
        0b01111110,
        0b00000100,
        0b00000100,
        0b00000000,
    ],
    "5": [
        0b01111110,
        0b01000000,
        0b01111100,
        0b00000010,
        0b00000010,
        0b01000010,
        0b00111100,
        0b00000000,
    ],
    "6": [
        0b00111100,
        0b01000000,
        0b01000000,
        0b01111100,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
    ],
    "7": [
        0b01111110,
        0b00000010,
        0b00000100,
        0b00001000,
        0b00010000,
        0b00100000,
        0b00100000,
        0b00000000,
    ],
    "8": [
        0b00111100,
        0b01000010,
        0b01000010,
        0b00111100,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
    ],
    "9": [
        0b00111100,
        0b01000010,
        0b01000010,
        0b00111110,
        0b00000010,
        0b00000010,
        0b00111100,
        0b00000000,
    ],
    " ": [0b00000000] * 8,
}

@dataclass
class BitmapFont:
    width: int = 8
    height: int = 8
    glyphs: Dict[str, Sequence[int]] = None

    def __post_init__(self):
        if self.glyphs is None:
            self.glyphs = GLYPHS

    def get_glyph(self, ch: str) -> Sequence[int]:
        # Uppercase mapping; unknown â†’ space
        ch = ch.upper()
        return self.glyphs.get(ch, self.glyphs.get(" ", [0] * self.height))


class TextRenderer:
    def __init__(self, font: BitmapFont):
        self.font = font

    def draw_char(
        self,
        buf: np.ndarray,
        x: int,
        y: int,
        ch: str,
        rgba: Tuple[int, int, int, int],
    ) -> None:
        h, w, _ = buf.shape
        glyph = self.font.get_glyph(ch)

        for row in range(self.font.height):
            yy = y + row
            if yy < 0 or yy >= h:
                continue
            row_bits = glyph[row]
            for col in range(self.font.width):
                xx = x + col
                if xx < 0 or xx >= w:
                    continue
                mask = 1 << (7 - col)  # bit 7 is leftmost
                if row_bits & mask:
                    buf[yy, xx, 0] = rgba[0]
                    buf[yy, xx, 1] = rgba[1]
                    buf[yy, xx, 2] = rgba[2]
                    buf[yy, xx, 3] = rgba[3]

    def draw_text(
        self,
        buf: np.ndarray,
        x: int,
        y: int,
        text: str,
        rgba: Tuple[int, int, int, int],
        spacing: int = 1,
    ) -> None:
        cursor_x = x
        cursor_y = y
        for ch in text:
            if ch == "\n":
                cursor_y += self.font.height + spacing
                cursor_x = x
                continue
            self.draw_char(buf, cursor_x, cursor_y, ch, rgba)
            cursor_x += self.font.width + spacing
