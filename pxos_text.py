from __future__ import annotations
from dataclasses import dataclass, field
from typing import Dict, Sequence, Tuple
import numpy as np

# Basic 8x8 font; extend GLYPHS gradually
GLYPHS: Dict[str, Sequence[int]] = {
    "A": [0b01111100, 0b10000010, 0b10000010, 0b11111110, 0b10000010, 0b10000010, 0b10000010, 0b00000000],
    "B": [0b11111100, 0b10000010, 0b10000010, 0b11111100, 0b10000010, 0b10000010, 0b11111100, 0b00000000],
    "C": [0b01111110, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b01111110, 0b00000000],
    "D": [0b11111100, 0b10000010, 0b10000010, 0b10000010, 0b10000010, 0b10000010, 0b11111100, 0b00000000],
    "E": [0b11111110, 0b10000000, 0b10000000, 0b11111100, 0b10000000, 0b10000000, 0b11111110, 0b00000000],
    "F": [0b11111110, 0b10000000, 0b10000000, 0b11111100, 0b10000000, 0b10000000, 0b10000000, 0b00000000],
    "G": [0b01111110, 0b10000000, 0b10000000, 0b10001110, 0b10000010, 0b10000010, 0b01111110, 0b00000000],
    "H": [0b10000010, 0b10000010, 0b10000010, 0b11111110, 0b10000010, 0b10000010, 0b10000010, 0b00000000],
    "I": [0b11111110, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b11111110, 0b00000000],
    "J": [0b00000110, 0b00000100, 0b00000100, 0b00000100, 0b10000100, 0b10000100, 0b01111000, 0b00000000],
    "K": [0b10000110, 0b10001100, 0b10011000, 0b11110000, 0b10011000, 0b10001100, 0b10000110, 0b00000000],
    "L": [0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111110, 0b00000000],
    "M": [0b10000010, 0b11000110, 0b10101010, 0b10010010, 0b10000010, 0b10000010, 0b10000010, 0b00000000],
    "N": [0b10000010, 0b11000010, 0b10100010, 0b10010010, 0b10001010, 0b10000110, 0b10000010, 0b00000000],
    "O": [0b01111100, 0b10000010, 0b10000010, 0b10000010, 0b10000010, 0b10000010, 0b01111100, 0b00000000],
    "P": [0b11111100, 0b10000010, 0b10000010, 0b11111100, 0b10000000, 0b10000000, 0b10000000, 0b00000000],
    "Q": [0b01111100, 0b10000010, 0b10000010, 0b10000010, 0b10001010, 0b10000100, 0b01111110, 0b00000000],
    "R": [0b11111100, 0b10000010, 0b10000010, 0b11111100, 0b10010000, 0b10001000, 0b10000100, 0b00000000],
    "S": [0b01111110, 0b10000000, 0b10000000, 0b01111100, 0b00000010, 0b00000010, 0b11111100, 0b00000000],
    "T": [0b11111110, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00000000],
    "U": [0b10000010, 0b10000010, 0b10000010, 0b10000010, 0b10000010, 0b10000010, 0b01111100, 0b00000000],
    "V": [0b10000010, 0b10000010, 0b10000010, 0b01000100, 0b01000100, 0b00101000, 0b00010000, 0b00000000],
    "W": [0b10000010, 0b10000010, 0b10000010, 0b10010010, 0b10101010, 0b01000100, 0b01000100, 0b00000000],
    "X": [0b10000010, 0b01000100, 0b00101000, 0b00010000, 0b00101000, 0b01000100, 0b10000010, 0b00000000],
    "Y": [0b10000010, 0b01000100, 0b00101000, 0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00000000],
    "Z": [0b11111110, 0b00000100, 0b00001000, 0b00010000, 0b00100000, 0b01000000, 0b11111110, 0b00000000],
    " ": [0]*8,
    "0": [0b01111100, 0b10000010, 0b10000110, 0b10001010, 0b10010010, 0b10100010, 0b01111100, 0b00000000],
    "1": [0b00100000, 0b01100000, 0b00100000, 0b00100000, 0b00100000, 0b00100000, 0b01110000, 0b00000000],
    "2": [0b01111100, 0b10000010, 0b00000010, 0b00000100, 0b00001000, 0b00010000, 0b11111110, 0b00000000],
    "3": [0b01111100, 0b10000010, 0b00000010, 0b00111100, 0b00000010, 0b10000010, 0b01111100, 0b00000000],
    "4": [0b00000100, 0b00001100, 0b00010100, 0b00100100, 0b11111110, 0b00000100, 0b00000100, 0b00000000],
    "5": [0b11111110, 0b10000000, 0b11111100, 0b00000010, 0b00000010, 0b10000010, 0b01111100, 0b00000000],
    "6": [0b01111100, 0b10000000, 0b11111100, 0b10000010, 0b10000010, 0b10000010, 0b01111100, 0b00000000],
    "7": [0b11111110, 0b10000010, 0b00000100, 0b00001000, 0b00010000, 0b00100000, 0b00100000, 0b00000000],
    "8": [0b01111100, 0b10000010, 0b10000010, 0b01111100, 0b10000010, 0b10000010, 0b01111100, 0b00000000],
    "9": [0b01111100, 0b10000010, 0b10000010, 0b01111110, 0b00000010, 0b00000010, 0b01111100, 0b00000000],
}

@dataclass
class BitmapFont:
    width: int = 8
    height: int = 8
    glyphs: Dict[str, Sequence[int]] = field(default_factory=lambda: GLYPHS)

    def get_glyph(self, ch: str) -> Sequence[int]:
        return self.glyphs.get(ch, self.glyphs.get(" ", [0] * self.height))

class TextRenderer:
    def __init__(self, font: BitmapFont):
        self.font = font

    def draw_char(
        self,
        buf: np.ndarray,
        x: int,
        y: int,
        ch: str,
        rgba: Tuple[int, int, int, int],
    ) -> None:
        h, w, _ = buf.shape
        glyph = self.font.get_glyph(ch)

        for row_idx, row_bits in enumerate(glyph):
            py = y + row_idx
            if 0 <= py < h:
                for col_idx in range(self.font.width):
                    px = x + col_idx
                    if 0 <= px < w:
                        if (row_bits >> (7 - col_idx)) & 1:
                            buf[py, px] = rgba

    def draw_text(
        self,
        buf: np.ndarray,
        x: int,
        y: int,
        text: str,
        rgba: Tuple[int, int, int, int],
        spacing: int = 1,
    ) -> None:
        cursor_x = x
        for ch in text:
            if ch == '\\n':
                y += self.font.height + spacing
                cursor_x = x
                continue
            self.draw_char(buf, cursor_x, y, ch, rgba)
            cursor_x += self.font.width + spacing
